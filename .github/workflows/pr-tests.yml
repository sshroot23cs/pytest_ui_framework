# GitHub Actions Workflow for Automated E2E Testing
# Triggers on Pull Requests to main branch and runs comprehensive test suite

name: ğŸ§ª E2E Test Suite - PR Validation

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, master ]

# Cancel previous workflow runs if new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'

jobs:
  # Job 1: Code Quality and Linting
  code-quality:
    name: ğŸ“‹ Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort
    
    - name: ğŸ§¹ Code Formatting Check (Black)
      run: black --check --diff .
      continue-on-error: true
    
    - name: ğŸ“ Import Sorting Check (isort)
      run: isort --check-only --diff .
      continue-on-error: true
    
    - name: ğŸ” Linting (Flake8)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true
    
    - name: âœ… Framework Validation
      run: python validate_framework.py

  # Job 2: E2E Test Execution (Chrome)
  e2e-tests-chrome:
    name: ğŸŒ E2E Tests (Chrome)
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸŒ Set up Node.js (for Allure)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¯ Install Allure Commandline
      run: npm install -g allure-commandline
    
    - name: ğŸ”§ Install Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ğŸ“ Create Reports Directory
      run: mkdir -p reports/allure-results reports/screenshots
    
    - name: ğŸ§ª Run E2E Tests (Chrome)
      run: |
        python -m pytest tests/test_e2e_search.py \
          -v \
          --browser=chrome \
          --headless \
          --alluredir=reports/allure-results \
          --junitxml=reports/junit-report.xml \
          --html=reports/html-report.html \
          --self-contained-html
      env:
        HEADLESS: true
        DISPLAY: :99
    
    - name: ğŸ“Š Generate Allure Report
      if: always()
      run: |
        allure generate reports/allure-results -o reports/allure-report --clean
    
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: chrome-test-results
        path: |
          reports/
          screenshots/
        retention-days: 30
    
    - name: ğŸ“ˆ Publish Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Chrome E2E Test Results
        path: reports/junit-report.xml
        reporter: java-junit

  # Job 3: E2E Test Execution (Firefox)
  e2e-tests-firefox:
    name: ğŸ¦Š E2E Tests (Firefox) 
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸŒ Set up Node.js (for Allure)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¯ Install Allure Commandline
      run: npm install -g allure-commandline
    
    - name: ğŸ”§ Install Firefox and GeckoDriver
      uses: browser-actions/setup-firefox@latest
    
    - name: ğŸ“ Create Reports Directory
      run: mkdir -p reports/allure-results reports/screenshots
    
    - name: ğŸ§ª Run E2E Tests (Firefox)
      run: |
        python -m pytest tests/test_e2e_search.py \
          -v \
          --browser=firefox \
          --headless \
          --alluredir=reports/allure-results \
          --junitxml=reports/junit-report.xml \
          --html=reports/html-report.html \
          --self-contained-html
      env:
        HEADLESS: true
        DISPLAY: :99
    
    - name: ğŸ“Š Generate Allure Report
      if: always()
      run: |
        allure generate reports/allure-results -o reports/allure-report --clean
    
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firefox-test-results
        path: |
          reports/
          screenshots/
        retention-days: 30

  # Job 4: Docker Environment Test
  docker-tests:
    name: ğŸ³ Docker Environment Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ—ï¸ Build Docker Image
      run: |
        docker build -f Dockerfile.local -t pytest-ui-framework:test .
    
    - name: ğŸ“ Create Host Directories
      run: |
        mkdir -p $(pwd)/reports $(pwd)/screenshots $(pwd)/logs
    
    - name: ğŸ§ª Run Tests in Docker
      run: |
        docker run --rm \
          -v $(pwd)/reports:/app/reports \
          -v $(pwd)/screenshots:/app/screenshots \
          -v $(pwd)/logs:/app/logs \
          -e HEADLESS=true \
          -e ENVIRONMENT=ci-docker \
          pytest-ui-framework:test \
          python -m pytest tests/test_e2e_search.py -v \
          --alluredir=/app/reports/allure-results \
          --junitxml=/app/reports/junit-report.xml
    
    - name: ğŸ“¤ Upload Docker Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-test-results
        path: |
          reports/
          screenshots/
          logs/
        retention-days: 30

  # Job 5: Test Results Summary
  test-summary:
    name: ğŸ“‹ Test Results Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests-chrome, e2e-tests-firefox, docker-tests]
    if: always()
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download All Test Results
      uses: actions/download-artifact@v4
      with:
        path: all-results
    
    - name: ğŸ“Š Create Test Summary
      run: |
        echo "# ğŸ§ª E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ˆ Test Execution Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if Chrome tests passed
        if [ -f "all-results/chrome-test-results/reports/junit-report.xml" ]; then
          echo "âœ… **Chrome Tests**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Chrome Tests**: Failed or not run" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check if Firefox tests passed
        if [ -f "all-results/firefox-test-results/reports/junit-report.xml" ]; then
          echo "âœ… **Firefox Tests**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Firefox Tests**: Failed or not run" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check if Docker tests passed
        if [ -f "all-results/docker-test-results/reports/junit-report.xml" ]; then
          echo "âœ… **Docker Tests**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Docker Tests**: Failed or not run" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ **Allure Reports**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“„ **HTML Reports**: Self-contained test reports" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š **JUnit XML**: For CI/CD integration" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¸ **Screenshots**: Captured on test failures" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— PR Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Job 6: PR Status Check
  pr-status-check:
    name: âœ… PR Status Check
    runs-on: ubuntu-latest
    needs: [e2e-tests-chrome, e2e-tests-firefox, docker-tests]
    if: always()
    
    steps:
    - name: ğŸ¯ Evaluate Test Results
      run: |
        if [ "${{ needs.e2e-tests-chrome.result }}" == "success" ] && \
           [ "${{ needs.e2e-tests-firefox.result }}" == "success" ] && \
           [ "${{ needs.docker-tests.result }}" == "success" ]; then
          echo "âœ… All tests passed! PR is ready for review."
          exit 0
        else
          echo "âŒ Some tests failed. Please check the test results."
          echo "Chrome Tests: ${{ needs.e2e-tests-chrome.result }}"
          echo "Firefox Tests: ${{ needs.e2e-tests-firefox.result }}"
          echo "Docker Tests: ${{ needs.docker-tests.result }}"
          exit 1
        fi